<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Plinko Premium â€” RTP ciblÃ© 25%</title>
  <style>
    :root{
      --bg-start:#0a0e1f;--bg-end:#1a1f35;--panel:#0f1428;--accent:#ff4757;--accent-hover:#ff3742;
      --success:#2ed573;--gold:#ffa502;--muted:#6c7293;--bright:#ffffff;--glass:rgba(255,255,255,0.08);
    }
    
    * { box-sizing: border-box; }
    html,body{height:100%;margin:0;font-family:'Inter', -apple-system, system-ui, sans-serif;
      background:linear-gradient(135deg,var(--bg-start) 0%, var(--bg-end) 100%);
      color:var(--bright);overflow-x:hidden}
    
    .wrap{max-width:1100px;margin:20px auto;padding:24px;
      background:linear-gradient(145deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
      border-radius:20px;border:1px solid rgba(255,255,255,0.1);
      box-shadow:0 20px 60px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.1)}
    
    header{text-align:center;margin-bottom:24px}
    h1{margin:0;font-size:28px;font-weight:700;background:linear-gradient(135deg, #ff4757, #ffa502);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .subtitle{color:var(--muted);font-size:14px;margin-top:8px}
    
    .controls{display:flex;gap:12px;margin-bottom:24px;align-items:center;flex-wrap:wrap;justify-content:center}
    .btn-group{display:flex;gap:8px;background:rgba(255,255,255,0.03);padding:4px;border-radius:12px;border:1px solid rgba(255,255,255,0.1)}
    
    button{background:linear-gradient(135deg, var(--accent), var(--accent-hover));border:none;color:white;
      padding:12px 20px;border-radius:10px;cursor:pointer;font-weight:600;font-size:14px;
      transition:all 0.3s ease;position:relative;overflow:hidden}
    button:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(255,71,87,0.3)}
    button:active{transform:translateY(0)}
    button[disabled]{opacity:0.5;cursor:not-allowed;transform:none !important}
    
    .btn-multi{background:linear-gradient(135deg, var(--gold), #ff7675);padding:10px 16px}
    .btn-multi:hover{box-shadow:0 8px 25px rgba(255,165,2,0.3)}
    
    .btn-reset{background:linear-gradient(135deg, #6c5ce7, #a29bfe);padding:10px 16px;margin-left:8px}
    .btn-reset:hover{box-shadow:0 8px 25px rgba(108,92,231,0.3)}
    
    .stats{display:flex;gap:16px;align-items:center;flex-wrap:wrap;justify-content:center}
    .stat{background:var(--glass);padding:8px 16px;border-radius:10px;border:1px solid rgba(255,255,255,0.1)}
    .stat-value{font-weight:700;color:var(--success)}
    
    .game{display:flex;gap:24px;align-items:flex-start}
    
    .board{width:680px;height:560px;
      background:linear-gradient(180deg,rgba(15,20,40,0.8), rgba(10,15,30,0.9));
      border-radius:16px;padding:20px;position:relative;overflow:hidden;
      border:2px solid rgba(255,255,255,0.1);
      box-shadow:inset 0 4px 20px rgba(0,0,0,0.3)}
    
    canvas{background:transparent;display:block;margin:0 auto;border-radius:8px}
    
    .sidebar{flex:1;min-width:280px}
    .info{background:var(--glass);padding:20px;border-radius:16px;border:1px solid rgba(255,255,255,0.1)}
    .info h3{margin:0 0 16px 0;font-size:18px;color:var(--gold)}
    
    .bins{position:absolute;left:16px;right:16px;bottom:20px;height:100px;
      display:flex;align-items:flex-end;justify-content:space-between;gap:2px}
    .bin{flex:1;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;
      padding:8px 4px;border-radius:8px 8px 4px 4px;
      background:linear-gradient(180deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
      border:1px solid rgba(255,255,255,0.1);position:relative;overflow:hidden}
    
    .bin::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;
      background:linear-gradient(90deg, var(--accent), var(--gold))}
    
    .bin .mult{background:rgba(255,255,255,0.15);padding:4px 6px;border-radius:6px;
      font-weight:700;font-size:11px;color:var(--bright);
      box-shadow:0 2px 8px rgba(0,0,0,0.2)}
    
    .results{max-height:280px;overflow-y:auto;margin-top:16px;
      background:rgba(0,0,0,0.2);padding:12px;border-radius:12px;
      border:1px solid rgba(255,255,255,0.05)}
    
    .result-line{padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.05);font-size:13px;
      display:flex;justify-content:space-between;align-items:center}
    .result-line:last-child{border-bottom:none}
    .result-win{color:var(--success);font-weight:600}
    .result-loss{color:var(--accent);opacity:0.7}
    
    .slot-legend{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:16px}
    .chip{padding:8px 12px;border-radius:10px;background:var(--glass);
      font-size:12px;border:1px solid rgba(255,255,255,0.1);text-align:center}
    
    .meter{margin-top:16px;padding:12px;background:rgba(0,0,0,0.2);border-radius:10px}
    .meter-label{font-size:13px;color:var(--muted);margin-bottom:4px}
    .meter-value{font-size:18px;font-weight:700;color:var(--success)}
    
    .progress{margin-top:8px}
    .progress-bar{height:6px;background:rgba(255,255,255,0.1);border-radius:3px;overflow:hidden}
    .progress-fill{height:100%;background:linear-gradient(90deg, var(--accent), var(--success));
      border-radius:3px;transition:width 0.3s ease}
    
    /* Animations pour les boules */
    .ball{position:absolute;width:20px;height:20px;border-radius:50%;
      background:radial-gradient(circle at 30% 30%, #fff 0%, #fff8 20%, var(--gold) 60%, var(--accent) 100%);
      box-shadow:0 4px 15px rgba(255,71,87,0.4);z-index:10;
      animation:ballGlow 0.1s ease-in-out infinite alternate}
    
    @keyframes ballGlow{
      from{box-shadow:0 4px 15px rgba(255,71,87,0.4)}
      to{box-shadow:0 6px 20px rgba(255,71,87,0.6)}
    }
    
    .multi-progress{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
      background:rgba(0,0,0,0.9);padding:20px;border-radius:16px;z-index:1000;
      border:1px solid rgba(255,255,255,0.2)}
    .multi-progress.active{display:block}
    
    /* Responsive */
    @media (max-width: 768px) {
      .game{flex-direction:column}
      .board{width:100%;max-width:600px}
      .controls{justify-content:center}
      .stats{justify-content:center}
    }
    
    /* Scrollbar styling */
    .results::-webkit-scrollbar{width:6px}
    .results::-webkit-scrollbar-track{background:rgba(255,255,255,0.05);border-radius:3px}
    .results::-webkit-scrollbar-thumb{background:var(--accent);border-radius:3px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ðŸŽ¯ Plinko Premium</h1>
      <div class="subtitle">Configuration RTP 25% â€” Simulation avancÃ©e</div>
    </header>

    <div class="controls">
      <div class="btn-group">
        <button id="dropBtn">ðŸŒ¹ Lancer 1 coup</button>
        <button id="drop10Btn" class="btn-multi">âš¡ 10 coups</button>
        <button id="drop100Btn" class="btn-multi">ðŸš€ 100 coups</button>
      </div>
      
      <button id="resetBtn" class="btn-reset">ðŸ”„ Reset</button>
      
      <div class="stats">
        <div class="stat">Total investi: <span class="stat-value" id="totalInvested">0</span> ðŸŒ¹</div>
        <div class="stat">Total gagnÃ©: <span class="stat-value" id="totalWon">0</span> ðŸŒ¹</div>
        <div class="stat">RÃ©sultat net: <span class="stat-value" id="netResult">0</span> ðŸŒ¹</div>
        <div class="stat">Coups jouÃ©s: <span class="stat-value" id="totalPlayed">0</span></div>
      </div>
    </div>

    <div class="game">
      <div class="board" id="board">
        <canvas id="pegs" width="640" height="420"></canvas>
        <div class="bins" id="bins"></div>
      </div>

      <div class="sidebar">
        <div class="info">
          <h3>ðŸ“Š Configuration des gains</h3>
          <div class="slot-legend" id="legend"></div>
          
          <div class="meter">
            <div class="meter-label">RTP Actuel</div>
            <div class="meter-value" id="currentRTP">â€”</div>
            <div class="progress">
              <div class="progress-bar">
                <div class="progress-fill" id="rtpProgress"></div>
              </div>
            </div>
          </div>
          
          <div class="results" id="results">
            <div style="text-align:center;color:var(--muted);padding:20px;">
              Lancez votre premiÃ¨re balle pour voir les rÃ©sultats !
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Progress modal for multi-drops -->
  <div class="multi-progress" id="multiProgress">
    <h3>ðŸŽ¯ Lancement en cours...</h3>
    <div class="progress">
      <div class="progress-bar">
        <div class="progress-fill" id="multiProgressFill"></div>
      </div>
    </div>
    <div id="multiProgressText">0 / 0 coups</div>
  </div>

  <script>
    // --- Configuration ---
    const TARGET_RTP = 0.25;
    const multipliers = [0, 0.25, 0.6, 2.5, 10];
    let weights = [null, 0.17, 0.08, 0.02, 0.01];
    
    // Game state
    let totalInvested = 0;
    let totalWon = 0;
    let totalPlayed = 0;
    let isRunning = false;
    
    function computeWeights() {
      const m = multipliers;
      let numerator = 0;
      for (let i = 1; i < m.length; i++) {
        numerator += weights[i] * (m[i] - TARGET_RTP);
      }
      const denom = (m[0] - TARGET_RTP);
      const w0 = -numerator / denom;
      
      if (!isFinite(w0) || w0 <= 0) {
        let scale = 1.0;
        for (let attempt = 0; attempt < 200; attempt++) {
          numerator = 0;
          for (let i = 1; i < m.length; i++) {
            numerator += (weights[i] * scale) * (m[i] - TARGET_RTP);
          }
          const tryw0 = -numerator / denom;
          if (tryw0 > 0 && isFinite(tryw0)) {
            weights[0] = tryw0;
            return;
          }
          scale *= 1.06;
        }
        weights[0] = 1.0;
      } else {
        weights[0] = w0;
      }
    }

    function getProbabilities() {
      const sum = weights.reduce((a, b) => a + b, 0);
      return weights.map(w => w / sum);
    }

    function computeRTP() {
      const probs = getProbabilities();
      let r = 0;
      for (let i = 0; i < multipliers.length; i++) r += probs[i] * multipliers[i];
      return r;
    }

    // Initialize
    computeWeights();
    const VISIBLE_BINS = 9;

    // UI Elements
    const elements = {
      bins: document.getElementById('bins'),
      legend: document.getElementById('legend'),
      results: document.getElementById('results'),
      currentRTP: document.getElementById('currentRTP'),
      totalInvested: document.getElementById('totalInvested'),
      totalWon: document.getElementById('totalWon'),
      netResult: document.getElementById('netResult'),
      totalPlayed: document.getElementById('totalPlayed'),
      rtpProgress: document.getElementById('rtpProgress'),
      dropBtn: document.getElementById('dropBtn'),
      drop10Btn: document.getElementById('drop10Btn'),
      drop100Btn: document.getElementById('drop100Btn'),
      multiProgress: document.getElementById('multiProgress'),
      multiProgressFill: document.getElementById('multiProgressFill'),
      multiProgressText: document.getElementById('multiProgressText'),
      resetBtn: document.getElementById('resetBtn')
    };

    // Update displays
    function updateStats() {
      elements.totalInvested.textContent = totalInvested.toFixed(2);
      elements.totalWon.textContent = totalWon.toFixed(2);
      const net = totalWon - totalInvested;
      elements.netResult.textContent = net.toFixed(2);
      elements.netResult.style.color = net >= 0 ? 'var(--success)' : 'var(--accent)';
      elements.totalPlayed.textContent = totalPlayed;
      
      const actualRTP = totalInvested > 0 ? (totalWon / totalInvested) : 0;
      elements.currentRTP.textContent = (actualRTP * 100).toFixed(2) + '%';
      elements.rtpProgress.style.width = Math.min(100, actualRTP * 400) + '%';
    }

    // Build bins
    function buildBins() {
      elements.bins.innerHTML = '';
      for (let i = 0; i < VISIBLE_BINS; i++) {
        const bin = document.createElement('div');
        bin.className = 'bin';
        const multSpan = document.createElement('div');
        multSpan.className = 'mult';
        multSpan.textContent = 'â€”';
        bin.appendChild(multSpan);
        elements.bins.appendChild(bin);
      }
    }

    // Build legend
    function buildLegend() {
      elements.legend.innerHTML = '';
      const probs = getProbabilities();
      for (let i = 0; i < multipliers.length; i++) {
        const chip = document.createElement('div');
        chip.className = 'chip';
        chip.innerHTML = `<div>x${multipliers[i]}</div><div>${(probs[i] * 100).toFixed(1)}%</div>`;
        elements.legend.appendChild(chip);
      }
    }

    // Draw pegs
    function drawPegs() {
      const canvas = document.getElementById('pegs');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // Gradient pegs
      const gradient = ctx.createRadialGradient(0, 0, 0, 0, 0, 6);
      gradient.addColorStop(0, 'rgba(255,255,255,0.3)');
      gradient.addColorStop(1, 'rgba(255,255,255,0.05)');
      ctx.fillStyle = gradient;
      
      const rows = 8;
      const cols = 10;
      const spacingX = canvas.width / (cols + 1);
      const spacingY = canvas.height / (rows + 2);
      
      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          const x = (c + 1) * spacingX + (r % 2 ? spacingX / 2 : 0);
          const y = 40 + r * spacingY;
          
          ctx.save();
          ctx.translate(x, y);
          ctx.fillStyle = gradient;
          ctx.beginPath();
          ctx.arc(0, 0, 5, 0, Math.PI * 2);
          ctx.fill();
          ctx.restore();
        }
      }
    }

    // Weighted selection
    function weightedChoice() {
      const ps = getProbabilities();
      const r = Math.random();
      let acc = 0;
      for (let i = 0; i < ps.length; i++) {
        acc += ps[i];
        if (r <= acc) return i;
      }
      return ps.length - 1;
    }

    // Map to visual bin
    function logicalToVisualIndex(slot) {
      const cumulative = [];
      const ps = getProbabilities();
      let s = 0;
      for (let i = 0; i < ps.length; i++) {
        s += ps[i];
        cumulative.push(s);
      }
      const r = cumulative[slot] - ps[slot] / 2;
      return Math.min(VISIBLE_BINS - 1, Math.floor(r * VISIBLE_BINS));
    }

    // Animate ball
    function animateBallTo(binIndex, onComplete, fast = false) {
      const boardRect = document.getElementById('board').getBoundingClientRect();
      const bins = document.querySelectorAll('.bin');
      const targetBin = bins[binIndex];
      const targetRect = targetBin.getBoundingClientRect();
      const boardEl = document.getElementById('board');

      const ball = document.createElement('div');
      ball.className = 'ball';
      boardEl.appendChild(ball);

      const startX = boardRect.width / 2 - 10;
      const startY = 10;
      const endX = targetRect.left - boardRect.left + targetRect.width / 2 - 10;
      const endY = boardRect.height - targetRect.height - 20;

      ball.style.left = startX + 'px';
      ball.style.top = startY + 'px';

      const duration = fast ? 300 + Math.random() * 200 : 1200 + Math.random() * 400;
      const start = performance.now();
      
      function frame(now) {
        const p = Math.min(1, (now - start) / duration);
        const easeP = p * p;
        
        const y = startY + (endY - startY) * easeP;
        const wobble = Math.sin(p * 15) * 8 * (1 - p);
        const x = startX + (endX - startX) * p + wobble;
        
        ball.style.left = x + 'px';
        ball.style.top = y + 'px';
        ball.style.transform = `scale(${1 - p * 0.1})`;
        
        if (p < 1) {
          requestAnimationFrame(frame);
        } else {
          setTimeout(() => {
            ball.remove();
            if (onComplete) onComplete();
          }, fast ? 100 : 300);
        }
      }
      requestAnimationFrame(frame);
    }

    // Add result to log
    function logResult(slot, multiplier, win) {
      const line = document.createElement('div');
      line.className = 'result-line';
      
      const left = document.createElement('span');
      left.textContent = `Slot ${slot} (x${multiplier})`;
      
      const right = document.createElement('span');
      right.className = win > 0 ? 'result-win' : 'result-loss';
      right.textContent = win > 0 ? `+${win.toFixed(2)}` : '0';
      
      line.appendChild(left);
      line.appendChild(right);
      
      // Clear placeholder
      if (elements.results.children[0]?.textContent?.includes('Lancez votre premiÃ¨re')) {
        elements.results.innerHTML = '';
      }
      
      elements.results.prepend(line);
      
      // Keep max 50 results
      while (elements.results.children.length > 50) {
        elements.results.removeChild(elements.results.lastChild);
      }
    }

    // Handle single drop
    function handleDrop(fast = false, onComplete = null) {
      const slot = weightedChoice();
      const vindex = logicalToVisualIndex(slot);
      
      animateBallTo(vindex, () => {
        const winMultiplier = multipliers[slot];
        const win = winMultiplier; // 1 rose base bet
        
        totalInvested += 1;
        totalWon += win;
        totalPlayed += 1;
        
        updateStats();
        logResult(slot, winMultiplier, win);
        
        if (onComplete) onComplete();
      }, fast);
    }

    // Handle multiple drops
    function handleMultipleDrop(count) {
      if (isRunning) return;
      isRunning = true;
      
      elements.multiProgress.classList.add('active');
      elements.multiProgressText.textContent = `0 / ${count} coups`;
      elements.multiProgressFill.style.width = '0%';
      
      // Disable buttons
      [elements.dropBtn, elements.drop10Btn, elements.drop100Btn].forEach(btn => {
        btn.disabled = true;
      });
      
      let completed = 0;
      
      function dropNext() {
        if (completed >= count) {
          elements.multiProgress.classList.remove('active');
          isRunning = false;
          [elements.dropBtn, elements.drop10Btn, elements.drop100Btn].forEach(btn => {
            btn.disabled = false;
          });
          return;
        }
        
        handleDrop(true, () => {
          completed++;
          const progress = (completed / count) * 100;
          elements.multiProgressFill.style.width = progress + '%';
          elements.multiProgressText.textContent = `${completed} / ${count} coups`;
          
          if (completed < count) {
            setTimeout(dropNext, 50); // Small delay between drops
          } else {
            setTimeout(() => {
              elements.multiProgress.classList.remove('active');
              isRunning = false;
              [elements.dropBtn, elements.drop10Btn, elements.drop100Btn].forEach(btn => {
                btn.disabled = false;
              });
            }, 500);
          }
        });
      }
      
      dropNext();
    }

    // Event listeners
    elements.dropBtn.addEventListener('click', () => {
      if (isRunning) return;
      isRunning = true;
      elements.dropBtn.disabled = true;
      handleDrop(false, () => {
        isRunning = false;
        elements.dropBtn.disabled = false;
      });
    });

    elements.drop10Btn.addEventListener('click', () => handleMultipleDrop(10));
    elements.drop100Btn.addEventListener('click', () => handleMultipleDrop(100));

    // Reset button
    elements.resetBtn.addEventListener('click', () => {
      if (isRunning) return;
      
      if (totalPlayed > 0 && !confirm('ÃŠtes-vous sÃ»r de vouloir remettre Ã  zÃ©ro toutes les statistiques ?')) {
        return;
      }
      
      // Reset all stats
      totalInvested = 0;
      totalWon = 0;
      totalPlayed = 0;
      
      // Clear results
      elements.results.innerHTML = '<div style="text-align:center;color:var(--muted);padding:20px;">Lancez votre premiÃ¨re balle pour voir les rÃ©sultats !</div>';
      
      // Update displays
      updateStats();
    });

    // Initialize UI
    buildBins();
    buildLegend();
    drawPegs();
    updateStats();
  </script>
</body>
</html>
